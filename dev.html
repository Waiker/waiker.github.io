<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TWA — Каталог курсов</title>
  
  <!-- Font Awesome (иконки) -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  
  <link rel="stylesheet" href="assets/css/style.css">
   -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
   const tg = window.Telegram.WebApp;
  tg.ready();
  tg.BackButton.hide();

  // Создаём блок для вывода логов
  const output = document.createElement('pre');
  output.id = 'auth-output';
  output.style.whiteSpace = 'pre-wrap';
  output.style.padding = '10px';
  output.style.fontFamily = 'monospace';
  output.style.background = '#f3f3f3';
  output.style.border = '1px solid #ccc';
  output.style.margin = '10px';
  document.body.appendChild(output);

  function print(msg) {
    output.textContent += msg + '\n';
  }

  // Обёртка try/catch для отлова глобальных ошибок
  try {
    print('Telegram WebApp ready...');
    print('tg.initData: ' + (tg.initData || 'пусто'));

    async function telegramAuth() {
      try {
        if (!tg.initData) {
          print('Ошибка: initData отсутствует!');
          return;
        }

        const res = await fetch('https://yourdomain.com/api/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg.initData })
        });

        print('Ответ от fetch получен, статус: ' + res.status);

        let data;
        try {
          data = await res.json();
        } catch (jsonErr) {
          print('Ошибка парсинга JSON: ' + jsonErr.message);
          const text = await res.text();
          print('Текст ответа: ' + text);
          return;
        }

        if (!res.ok) {
          print('Ошибка авторизации: ' + JSON.stringify(data));
          return;
        }

        print('JWT token: ' + data.token);
        print('Пользователь: ' + JSON.stringify(data.user));
        localStorage.setItem('jwt_token', data.token);
        tg.BackButton.show();
        print('Авторизация прошла успешно!');
      } catch (err) {
        print('Ошибка запроса fetch: ' + err.message);
      }
    }

    telegramAuth();

  } catch (err) {
    print('Глобальная ошибка: ' + err.message);
  }
</script>
</head>
<body>

</body>
</html>
